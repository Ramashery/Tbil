<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Firebase Test Page (v2)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { margin: 5px; padding: 10px; cursor: pointer; }
        pre { background-color: #f4f4f4; padding: 15px; border: 1px solid #ddd; white-space: pre-wrap; word-wrap: break-word; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Firebase Firestore Test (v2)</h1>
    <div id="results"></div>

    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="cleanup()">Delete Test Data</button>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCZZ7kICCJMcWAjW5bnf_-vsH2s-KoZrSs",
            authDomain: "tbil-home.firebaseapp.com",
            projectId: "tbil-home",
            storageBucket: "tbil-home.firebasestorage.app",
            messagingSenderId: "849747940427",
            appId: "1:849747940427:web:bd3744d816a25e62c7e9ce",
            measurementId: "G-7YWSRMGV33"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const resultsDiv = document.getElementById('results');
        
        const TEST_ROOM_ID = 'test_room_123';
        let testBookingId = null;

        const log = (message, type = 'info') => {
            resultsDiv.innerHTML += `<p class="${type}">${new Date().toLocaleTimeString()} - ${message}</p>`;
        };

        async function test1_createRoom() {
            log('Test 1: Creating a test room...');
            try {
                await db.collection('rooms').doc(TEST_ROOM_ID).set({
                    title: 'Test Room',
                    capacity: 4,
                    price: 50
                });
                log('Test 1 PASSED: Test room created successfully.', 'success');
            } catch (e) {
                log(`Test 1 FAILED: ${e.message}`, 'error');
            }
        }

        async function test2_readRooms() {
            log('Test 2: Reading all rooms...');
            try {
                const snapshot = await db.collection('rooms').get();
                const rooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                log(`Test 2 PASSED: Found ${snapshot.size} rooms.`, 'success');
                resultsDiv.innerHTML += `<pre>${JSON.stringify(rooms, null, 2)}</pre>`;
            } catch (e) {
                log(`Test 2 FAILED: ${e.message}`, 'error');
            }
        }

        async function test3_createBooking() {
            log('Test 3: Creating a test booking...');
            try {
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);

                const newBooking = {
                    roomId: TEST_ROOM_ID,
                    guests: 2,
                    checkInDate: today.toISOString().split('T')[0],
                    checkOutDate: tomorrow.toISOString().split('T')[0],
                    userName: 'Test User'
                };
                const docRef = await db.collection('bookings').add(newBooking);
                testBookingId = docRef.id;
                log(`Test 3 PASSED: Test booking created with ID: ${testBookingId}`, 'success');
            } catch (e) {
                log(`Test 3 FAILED: ${e.message}`, 'error');
            }
        }

        async function test4_checkAvailability() {
            log('Test 4: Checking availability logic...');
            try {
                const room = (await db.collection('rooms').doc(TEST_ROOM_ID).get()).data();
                const bookingsSnapshot = await db.collection('bookings').where('roomId', '==', TEST_ROOM_ID).get();
                const bookings = bookingsSnapshot.docs.map(doc => doc.data());
                
                const todayStr = new Date().toISOString().split('T')[0];
                let bookedGuests = 0;
                for (const booking of bookings) {
                    if (new Date(todayStr) >= new Date(booking.checkInDate) && new Date(todayStr) < new Date(booking.checkOutDate)) {
                        // ИСПРАВЛЕНИЕ: Добавлена проверка на случай, если поле guests отсутствует
                        bookedGuests += (booking.guests || 1); 
                    }
                }
                const availableSpots = room.capacity - bookedGuests;
                
                if (availableSpots === 2) { // Expected: 4 (capacity) - 2 (booked) = 2
                    log(`Test 4 PASSED: Availability check is correct. Available spots: ${availableSpots}`, 'success');
                } else {
                    log(`Test 4 FAILED: Availability check is WRONG. Expected 2, but got ${availableSpots}`, 'error');
                }
            } catch (e) {
                log(`Test 4 FAILED: ${e.message}`, 'error');
            }
        }

        async function cleanup() {
            log('Cleanup: Deleting test data...');
            try {
                // Сначала удаляем бронирования
                const bookingsQuery = await db.collection('bookings').where('roomId', '==', TEST_ROOM_ID).get();
                const deletePromises = [];
                bookingsQuery.forEach(doc => {
                    deletePromises.push(doc.ref.delete());
                });
                await Promise.all(deletePromises);
                log(`Cleanup: Deleted ${bookingsQuery.size} test bookings.`, 'success');

                // Затем удаляем комнату
                await db.collection('rooms').doc(TEST_ROOM_ID).delete();
                log('Cleanup: Test room deleted.', 'success');
                
                log('Cleanup finished.', 'success');
            } catch (e) {
                log(`Cleanup FAILED: ${e.message}`, 'error');
            }
        }

        async function runAllTests() {
            resultsDiv.innerHTML = '';
            // Сначала очищаем старые данные на случай, если они остались
            await cleanup();
            log('------------------------------------');
            // Затем запускаем тесты
            await test1_createRoom();
            await test2_readRooms();
            await test3_createBooking();
            await test4_checkAvailability();
        }
    </script>
</body>
</html>